apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "livepeer.fullname" . }}-broadcaster
  labels:
    app.kubernetes.io/name: {{ include "livepeer.name" . }}-broadcaster
    helm.sh/chart: {{ include "livepeer.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
data:
  nginx.conf: |
    worker_processes auto;

    events {
      worker_connections 1024;
    }

    http {
      ssl_certificate /tls/tls.crt;
      ssl_certificate_key /tls/tls.key;
      # ssl_ciphers EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH;
      # ssl_protocols TLSv1.1 TLSv1.2;

      server {
        listen 80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
      }

      server {
        listen 443 ssl default_server;
        listen [::]:443 ssl default_server;

        client_max_body_size 50M; # Arbitrary, but the default is 1M and that won't do.

        server_name _;

        location /live {
          proxy_pass http://127.0.0.1:7935;
        }

        location /stream {
          proxy_pass http://127.0.0.1:8935;
        }
      }
    }
